var validPaths = {
  "items.data.@context": "https://www.openactive.io/ns-beta/oa.jsonld",
  "items.data.activity": "Circuits",
  "items.data.activity.id": "http://openactive.io/activity-list/#f2ea7405-6098-4378-b0fe-4e398a659fc4",
  "items.data.activity.inScheme": "https://www.openactive.io/activity-list/activity-list.jsonld",
  "items.data.activity.notation": 32,
  "items.data.activity.prefLabel": "Tennis",
  "items.data.activity.type": "skos:Concept",
  "items.data.ageRange": "16-55",
  "items.data.beta:attendeeCount": 4,
  "items.data.beta:availability": ">2",
  "items.data.beta:formattedDescription": "<p>A new volume of choreography is being released. Come and learn the new routines properly  in person.</p>\n",
  "items.data.beta:level": "",
  "items.data.category": "Tennis Tuesdays",
  "items.data.contributor.name": "Gym Instructor ",
  "items.data.contributor.type": "Person",
  "items.data.description": "For ladies who like to compete",
  "items.data.duration": "PT30M",
  "items.data.endDate": "2017-03-25T10:29:59Z",
  "items.data.eventStatus": "http://schema.org/EventScheduled",
  "items.data.genderRestriction": "mixed",
  "items.data.identifier": "fd14f36c-a193-4607-92f3-0ca9538737aa",
  "items.data.image": "",
  "items.data.isCoached": false,
  "items.data.level": "All",
  "items.data.location": null,
  "items.data.location.address": "Leisure World Highwoods, Attwood Cl, Colchester, CO4 9FE",
  "items.data.location.address.addressLocality": "LONDON",
  "items.data.location.address.addressRegion": "Devon",
  "items.data.location.address.postalCode": "W9 1PD",
  "items.data.location.address.streetAddress": "The Pavilion\r\nPaddington Recreation Ground\r\nRandolph Avenue",
  "items.data.location.address.type": "PostalAddress",
  "items.data.location.containedInPlace.address.addressLocality": "Camden",
  "items.data.location.containedInPlace.address.addressRegion": "London West",
  "items.data.location.containedInPlace.address.postalCode": "SS5 4LN",
  "items.data.location.containedInPlace.address.streetAddress": "Clements Hall Way",
  "items.data.location.containedInPlace.address.type": "PostalAddress",
  "items.data.location.containedInPlace.geo.latitude": 51.5475,
  "items.data.location.containedInPlace.geo.longitude": -0.144713,
  "items.data.location.containedInPlace.identifier": "R2CHC",
  "items.data.location.containedInPlace.name": "Clements Hall Leisure Centre",
  "items.data.location.containedInPlace.telephone": "01702 207777",
  "items.data.location.containedInPlace.type": "Place",
  "items.data.location.containedInPlace.url": "",
  "items.data.location.description": "Parking in car park on site.",
  "items.data.location.geo.latitude": 51.52799,
  "items.data.location.geo.longitude": -0.191827,
  "items.data.location.geo.type": "GeoCoordinates",
  "items.data.location.identifier": "93cf15b7-b1df-4474-bdfb-744ca1bf97d6",
  "items.data.location.name": "Paddington Recreation Ground",
  "items.data.location.telephone": "01206 282000",
  "items.data.location.type": "Place",
  "items.data.location.url": "https://colchesterleisureworld.co.uk/highwoods/",
  "items.data.maximumAttendeeCapacity": 40,
  "items.data.name": "Tennis Tuesdays",
  "items.data.offer.beta:groupTicket.beta:maxPeople": 2,
  "items.data.offer.beta:groupTicket.beta:minPeople": 2,
  "items.data.offer.description": "Valid for 2 spaces at the same session.",
  "items.data.offer.eligibleCustomerType": "Member",
  "items.data.offer.identifier": "SINGLE-MEMBER",
  "items.data.offer.name": "Single session (Member)",
  "items.data.offer.price": 0,
  "items.data.offer.priceCurrency": "GBP",
  "items.data.offer.type": "Offer",
  "items.data.offer.url": "https://better.legendonlineservices.co.uk/enterprise/account/Login",
  "items.data.organizer.beta:website": "https://bouncefitbody.com",
  "items.data.organizer.@type": "Organization",
  "items.data.organizer.email": "paddingtonactivities@everyoneactive.com",
  "items.data.organizer.id": "https://colchesterleisureworld.co.uk/",
  "items.data.organizer.identifier": "93cf15b7-b1df-4474-bdfb-744ca1bf97d6",
  "items.data.organizer.logo": "https://leisureworldcolchester.github.io/images/logo.png",
  "items.data.organizer.name": "Paddington Recreation Ground",
  "items.data.organizer.telephone": "03330050413",
  "items.data.organizer.type": "Organization",
  "items.data.organizer.url": "https://colchesterleisureworld.co.uk/",
  "items.data.remainingAttendeeCapacity": 9,
  "items.data.startDate": "2017-03-25T10:00:00Z",
  "items.data.subEvent.beta:availability": ">4",
  "items.data.subEvent.beta:urlTemplate": "https://bookwhen.com/bouncehatfieldheath/e/ev-shy4-{YYYYMMDDHHMISS}?r=oa",
  "items.data.subEvent.category": "Standard",
  "items.data.subEvent.description": "For ladies who like to compete",
  "items.data.subEvent.duration": "PT1H",
  "items.data.subEvent.endDate": "2017-01-15T19:00:00+02:00",
  "items.data.subEvent.eventSchedule.byDay": "https://schema.org/Friday",
  "items.data.subEvent.eventSchedule.endDate": "2015-12-25",
  "items.data.subEvent.eventSchedule.endTime": "10:30",
  "items.data.subEvent.eventSchedule.exceptDate": "2017-08-29T08:15:00Z",
  "items.data.subEvent.eventSchedule.frequency": "weekly",
  "items.data.subEvent.eventSchedule.interval": 1,
  "items.data.subEvent.eventSchedule.startDate": "2017-06-23",
  "items.data.subEvent.eventSchedule.startTime": "09:30",
  "items.data.subEvent.eventSchedule.type": "Schedule",
  "items.data.subEvent.eventStatus": "http://schema.org/EventScheduled",
  "items.data.subEvent.identifier": "92eccf6c-d9f4-4c44-9caa-f7caf2905946",
  "items.data.subEvent.isCoached": false,
  "items.data.subEvent.maximumAttendeeCapacity": 8,
  "items.data.subEvent.name": "Tennis Tuesdays",
  "items.data.subEvent.offer.eligibleCustomerType": "Member",
  "items.data.subEvent.offer.identifier": "SINGLE-MEMBER",
  "items.data.subEvent.offer.name": "Single session (Member)",
  "items.data.subEvent.offer.price": 0,
  "items.data.subEvent.offer.priceCurrency": "GBP",
  "items.data.subEvent.offer.type": "Offer",
  "items.data.subEvent.startDate": "2017-01-15T16:30:00+02:00",
  "items.data.subEvent.type": "Event",
  "items.data.subEvent.url": "https://clubspark.lta.org.uk/TennisTuesdays/Summary/92eccf6c-d9f4-4c44-9caa-f7caf2905946",
  "items.data.type": "Event",
  "items.data.url": "https://clubspark.lta.org.uk/TennisTuesdays",
  "items.id": "fd14f36c-a193-4607-92f3-0ca9538737aa",
  "items.kind": "Event",
  "items.modified": 1497482219527,
  "items.state": "updated",
  "license": "https://creativecommons.org/licenses/by/4.0/",
  "next": "https://api.clubspark.uk/odi/public/courses?afterTimestamp=1497482219527&afterID=fd14f36c-a193-4607-92f3-0ca9538737aa"
}





function loadJSON(url, cb) {
    $.support.cors = true;
    $.getJSON(url, function(data) {
        cb(data);
    }).fail(function( jqxhr, textStatus, error ) {
        var err = textStatus + ", " + error;
        console.log( "Error accessing GitHub: " + err );
    });
}

function getOpenActiveDatasets(success) {
    var url = 'https://www.openactive.io/datasets/directory.json';
    loadJSON(url, function (jsonBody) {
        success(jsonBody);
    });
}

function addRow(metadata) {
  console.log("Metadata for!: " + metadata["dataset-site-url"] );
  
  createRow("#data-user-section-list",
            metadata["dataset-site-url"] + "images/logo.png",
            metadata["dataset-site-url"],
            metadata["attribution-text"],
            metadata["description"],
            metadata["data-url"],
            metadata["example-url"]); 
}
  

function createPropertyRow(appendId,image,property,count,exampleValue, exists) {
   var newRow = $( "#property-row-template" ).clone();

   newRow.removeAttr("id"); 
   //newRow.find( "[data-field='image']" ).css('background-image', 'url(' + image + ')');
   /*newRow.find( "[data-field~='link']" ).click(function() {
        //activateProvider(title, dataUrl, false, newRow);
        return false;
   });//.attr("href", link); */
   newRow.find( "[data-field~='property']" ).text(property);
   if (count) newRow.find( "[data-field='count']" ).text(count);

   newRow.find( "[data-field='check']" ).prop( "checked", exists );

   newRow.find( "[data-field~='check']" ).change(function() {
      console.log("CHECK! Insert '" + exampleValue +  "' into" + property);
        try {
          var isChecked = $(this).prop( "checked" );

          var obj = JSON.parse(window.editor.getValue());

          if (!isChecked) {
            //Remove key
            removePropertyFromJson(property, obj);
          } else {
            insertValueIntoJson(property, obj, exampleValue);
          }
          
          var json = JSON.stringify(obj, null, 2);

          // TODO: This is a naive implementation, as the same property can exist in multiple places
          var searchString = '"' + property.split(".").slice(-1)[0] + '":';
          var index = json.indexOf(searchString);
          var beforeMatch = json.substring(0, index);
          var lines = beforeMatch.split(/\r\n|\r|\n/);
          var row = lines.length - 1;
          var column = lines.slice(-1)[0].length + searchString.length - 1;
          console.log("CURSOR:" + index + " r" + row + " c" + column);

          window.editor.setValue(json, -1);
          window.editor.selection.moveTo(row, column);

          $("#example").click();

          //$(this).prop( "checked", !isChecked );

          return true;
        } catch (e) {
          alert("Insert failed, please check the editor contains valid JSON. \n" + e.message);
          $(this).prop( "checked", !isChecked );
          return false;
        } 

        //activateProvider(title, dataUrl, false, newRow);

   });
  
   newRow.appendTo( appendId );

   newRow.show();
}


function createRow(appendId,image,link,title,description,dataUrl) {
   var newRow = $( "#row-template" ).clone();

   newRow.removeAttr("id"); 
   newRow.find( "[data-field='image']" ).css('background-image', 'url(' + image + ')');
   newRow.find( "[data-field~='link']" ).click(function() {
        activateProvider(title, dataUrl, false, newRow);
        return false;
   });//.attr("href", link);
   newRow.find( "[data-field~='title']" ).text(title);
   newRow.find( "[data-field='description']" ).text(description);

   //Add row to list
   newRow.appendTo( appendId );

   newRow.show();

   //HACK: sorting row after every new data item appears - would be much better to do this once after they've all loaded

    var cont = $( appendId ).children('li');

    cont.detach().sort(function(a, b) {
                var astts = $(a).find( "[data-field~='title']" ).text().toUpperCase();
                var bstts = $(b).find( "[data-field~='title']" ).text().toUpperCase();
                //return astts - bstts;
                return (astts > bstts) ? (astts > bstts) ? 1 : 0 : -1;
            });

    $( appendId ).append(cont);
}

function incrementCounter(queue, counter) {
  var url = queue.pop();
  if (url) {
    $.getJSON(url, function (metadata) {
        //Only continue if load successful, ignore failure
        console.log("Metadata for: " + metadata["dataset-site-url"] + " (Publish: " + metadata["publish"] + ")");
        if (metadata["publish"]) {
          counter ++;
          $( "#metric-live" ).text(counter);
        }
        incrementCounter(queue, counter);
    }).fail(function() {
        console.log("Error accessing: " + url);
        incrementCounter(queue, counter);
    });
  } else {
    // End of the list, do nothing
  }
}

function incrementCounter(queue, counter) {
  var url = queue.pop();
  if (url) {
    $.getJSON(url, function (metadata) {
        //Only continue if load successful, ignore failure
        console.log("Metadata for: " + metadata["dataset-site-url"] + " (Publish: " + metadata["publish"] + ")");
        if (metadata["publish"]) {
          counter ++;
          $( "#metric-live" ).text(counter);
        }
        incrementCounter(queue, counter);
    }).fail(function() {
        console.log("Error accessing: " + url);
        incrementCounter(queue, counter);
    });
  } else {
    // End of the list, do nothing
  }
}

/* 
 * On Page Load
 */
$(function() {
    $.fn.clickToggle = function(func1, func2) {
        var funcs = [func1, func2];
        this.data('toggleclicked', 0);
        this.click(function() {
            var data = $(this).data();
            var tc = data.toggleclicked;
            $.proxy(funcs[tc], this)();
            data.toggleclicked = (tc + 1) % 2;
        });
        return this;
    };

    $( "#data-user-section-list" ).each(function() {
      $( "#row-template" ).hide();
      getOpenActiveDatasets(function (body) {
          for(var i = 0; i < body.length; i++) {
            var metadata = body[i];
              console.log("Found: " + metadata.full_name );
              console.log("Metadata for: " + metadata["dataset-site-url"] + " (Publish: " + metadata["publish"] + ")");
              if (metadata["publish"]) {
                addRow(metadata);
                activateProvider(metadata["title"], metadata["data-url"], true);
              }
          }
      });
    });
  
    window.editor = ace.edit("code");
    editor.getSession().setUseWorker(true);
    editor.setTheme("ace/theme/clouds");
    editor.getSession().setMode("ace/mode/json");

    clickOverview();

    initContexts();

});
  
  
$(function() {
  $( "#metric-impl" ).each(function() {
    $.getJSON( "https://api.github.com/repos/openactive/users/milestones?state=all", function( data ) {
      $( "#metric-impl" ).text(data.length)
    });
  });
});

  var propertyListCount = {};
  var propertyExample = {};


  function calculateAggregatePropertyUsage(singlePropertyExample) {

      console.log("Analysing: " + JSON.stringify(singlePropertyExample, null, 2));

      if (singlePropertyExample["items.data.@context"] || singlePropertyExample["items.@context"]) {
        // Crack on !
      } else {
        //Temporarily only analyse implementors of modelling spec
        console.log("Ignoring: " + singlePropertyExample.next);
        return;
      }

      console.log("Analysis complete: " + singlePropertyExample.next);

      //var jsonExample = jsonFromPropertyList(propertyList);

      // Add these values to the count
      addToPropertyCount(singlePropertyExample, propertyListCount);

      console.log("Analysis added to total: " + singlePropertyExample.next);

      // Add values to example
      propertyExample = sort(extend(propertyExample, singlePropertyExample));

      jsonExample = jsonFromPropertyList(propertyExample);
      //merge nodeCount with current count
      //report[text] = {"test": 1, "text2":"test3"};

      //var annotatedResult = annotate(jsonExample, propertyListCount, true);
      //console.log("ANNOTATE: " + annotatedResult)

      $('#aggregateSummary').each(function(i, elm) {
        var block = $(this)
        block.text(annotate(jsonExample, propertyListCount, true));
        hljs.highlightBlock(elm);
      });
  }


function clickOverview() {
  $(".sidebar li").removeClass("active");
  $("#overview").addClass("active");
  $("#aggregateSummaryTab").click();
  $(".individual").hide();

  $("#property-row-template").hide(); //Just need to do this once on page load - put this somewhere better
  $("#property-list li").not( "#property-row-template" ).remove();
}



function activateProvider(title, dataUrl, init, elem) {
    $('#status').text("Fetching data...");
    console.log("Activating provider: " + title + "; " + dataUrl);
    $.getJSON("/api?url=" + encodeURIComponent(dataUrl), function (localPropertyExample) {
      if (init) {
        console.log("Activating provider: " + title + "; " + localPropertyExample.next);
          calculateAggregatePropertyUsage(localPropertyExample);
        } else {
          $.getJSON("/api?count=true&url=" + encodeURIComponent(dataUrl), function (localPropertyListCount) {


            
            $("#property-list-parent li").not( "#property-row-template" ).remove();

            //TODO replace propertyListCount with official list in the below!

            Object.keys(propertyExample).forEach(function(property) { 
              var exists = (property in localPropertyListCount);
              var propName = property.split(".").slice(-1)[0];

              var listId;
              if (property.indexOf("organization") > -1) {
                // HACK: Need to check all props of the path are good, not just the last one
                listId = "#property-list-errors";
              } else
              if (property == "items.data.@context") {
                //Allow context only at root of item
                listId = "#property-list";
              } else if (propName.substring(0,5) =="beta:" || property.indexOf("eventSchedule") > -1) { //HACK: eventSchedule as beta prop
                listId = "#property-list-beta";
              } else if (property in validPaths && (propName in contexts.schema.properties || propName in contexts.oa.properties || propName in contexts.builtin.properties)) {
                listId = "#property-list";
              } else if (propName in contexts.schema.properties) {
                listId = "#property-list-new";
              } else if (propName in contexts.oa.properties) {
                listId = "#property-list-new";
              } else {
                listId = "#property-list-errors";
              }
              createPropertyRow(listId,"",property,propertyListCount[property],propertyExample[property],exists);
            });


            

            jsonExample = jsonFromPropertyList(localPropertyExample);
            window.editor.session.setValue(JSON.stringify(jsonExample, null, 2));

            $('#singleSummary').each(function(i, elm) {
              var block = $(this);
              block.text(annotate(jsonExample, localPropertyListCount, false));
              hljs.highlightBlock(elm);
            });

            var activateFirstTab = $(".individual:visible").length == 0;

            $(".individual").show();
            $(".sidebar li").removeClass("active");
            $(elem).addClass("active");

            if (activateFirstTab) $("#example").click();
            

          }).always(function () {
            $('#status').text("");
          });
        } 
    }).fail(function ( jqxhr, textStatus, error ) {
      if (init) {
        $('#status').text("");
      } else {
        $('#status').text("Request ('" + dataUrl + "') failed");
      }
    });
}
